<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Fichas</title>

    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        h1 {
            color: #333;
            font-size: 24px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-novo, .btn-exportar {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .btn-exportar {
            background-color: #28a745;
        }

        .btn-novo:hover {
            background-color: #0056b3;
        }

        .btn-exportar:hover {
            background-color: #218838;
        }

        .btn-exportar:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .btn-exportar-glossario {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .btn-exportar-glossario:hover {
            background-color: #59359a;
        }

        .btn-exportar-glossario:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .acoes-cell {
            width: 150px;
        }

        .btn-acao {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-editar {
            background-color: #28a745;
            color: white;
        }

        .btn-excluir {
            background-color: #dc3545;
            color: white;
        }

        .btn-editar:hover {
            background-color: #218838;
        }

        .btn-excluir:hover {
            background-color: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #007bff;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciador de Fichas</h1>
            <div class="btn-group">
                <button id="btnExportar" class="btn-exportar" disabled>Exportar Ficha</button>
                <button id="btnExportarGlossario" class="btn-exportar-glossario" disabled>Exportar Glossário</button>
                <a href="novo.html" class="btn-novo">Nova Ficha</a>
            </div>
        </div>

        <div class="table-container">
            <table id="tabelaFichas">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>ID</th>
                        <th>Nome da Ficha</th>
                        <th>Data de Criação</th>
                        <th class="acoes-cell">Ações</th>
                    </tr>
                </thead>
                <tbody id="tbodyFichas">
                    <!-- As fichas serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
            <div id="loadingState" class="loading">
                <p>Carregando fichas...</p>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <p>Nenhuma ficha cadastrada. Clique em "Nova Ficha" para começar.</p>
            </div>
            <div id="errorState" class="error" style="display: none;">
                <p id="errorMessage">Erro ao carregar fichas.</p>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        // Import das funções da API
        import {
            obterTodasFichas,
            excluirFichaCompleta,
            exportarFichasParaPDF,
            exportarGlossarioParaPDF
        } from './api/api.js';

        // Elementos DOM
        const tabelaBody = document.getElementById('tbodyFichas');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const selectAll = document.getElementById('selectAll');
        const btnExportar = document.getElementById('btnExportar');
        const btnExportarGlossario = document.getElementById('btnExportarGlossario');

        // Inicializa a tabela
        async function inicializarTabela() {
            await carregarFichas();
            atualizarTodosBotoesExportar();
        }

        // Carrega as fichas da API
        async function carregarFichas() {
            try {
                mostrarLoading();
                const response = await obterTodasFichas();
                const fichas = extrairFichasDaResposta(response);
                renderizarTabela(fichas);
            } catch (error) {
                console.error('Erro ao carregar fichas:', error);
                mostrarErro('Erro ao carregar fichas: ' + error.message);
            }
        }

        // Função para extrair o array de fichas da resposta da API
        function extrairFichasDaResposta(response) {
            if (Array.isArray(response)) return response;
            if (typeof response === 'object' && response !== null) {
                if (response.data && Array.isArray(response.data)) return response.data;
                if (response.fichas && Array.isArray(response.fichas)) return response.fichas;
                if (response.result && Array.isArray(response.result)) return response.result;
                if (response.items && Array.isArray(response.items)) return response.items;
                const arrayFromObject = Object.values(response).filter(item =>
                    typeof item === 'object' && item !== null
                );
                if (arrayFromObject.length > 0) return arrayFromObject;
            }
            console.warn('Não foi possível extrair array de fichas da resposta:', response);
            return [];
        }

        // Renderiza a tabela com as fichas
        function renderizarTabela(fichas) {
            if (!fichas || !Array.isArray(fichas) || fichas.length === 0) {
                mostrarEmptyState();
                return;
            }

            esconderEstados();
            tabelaBody.innerHTML = '';

            fichas.forEach((ficha) => {
                const tr = document.createElement('tr');
                const dataCriacao = ficha.data_criacao
                    ? new Date(ficha.data_criacao).toLocaleDateString('pt-BR')
                    : 'N/A';
                const fichaId = ficha.id || ficha.codigo || ficha.ID || ficha.CODIGO;

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" data-id="${fichaId}" onchange="atualizarTodosBotoesExportar()">
                    </td>
                    <td>${fichaId || 'N/A'}</td>
                    <td>${ficha.nome_ficha || ficha.nome || 'Sem nome'}</td>
                    <td>${dataCriacao}</td>
                    <td class="acoes-cell">
                        <a href="editar.html?id=${fichaId}" class="btn-acao btn-editar">Editar</a>
                        <button class="btn-acao btn-excluir" onclick="confirmarExclusaoFicha('${fichaId}')">Excluir</button>
                    </td>
                `;
                tabelaBody.appendChild(tr);
            });
        }

        // Atualiza o estado do botão exportar
        function atualizarBotaoExportar() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            btnExportar.disabled = checkboxesSelecionados.length === 0;
        }

        // Atualiza o estado do botão exportar glossário
        function atualizarBotaoExportarGlossario() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            btnExportarGlossario.disabled = checkboxesSelecionados.length === 0;
        }

        // Atualiza todos os botões de exportação
        function atualizarTodosBotoesExportar() {
            atualizarBotaoExportar();
            atualizarBotaoExportarGlossario();
        }

        // Exporta as fichas selecionadas para PDF
        async function handleExportarFichasParaPDF() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxesSelecionados.length === 0) {
                await Swal.fire({
                    title: 'Nenhuma ficha selecionada',
                    text: 'Selecione pelo menos uma ficha para exportar.',
                    icon: 'warning',
                    confirmButtonColor: '#007bff'
                });
                return;
            }

            try {
                Swal.fire({
                    title: 'Exportando...',
                    text: 'Preparando o PDF com as fichas selecionadas',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const fichasIds = Array.from(checkboxesSelecionados).map(checkbox =>
                    checkbox.getAttribute('data-id')
                );

                await exportarFichasParaPDF(fichasIds);

                Swal.close();
                await Swal.fire({
                    title: 'Exportação concluída!',
                    text: `PDF gerado com ${fichasIds.length} ficha(s) selecionada(s).`,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
            } catch (error) {
                console.error('Erro ao exportar fichas:', error);
                Swal.close();
                await Swal.fire({
                    title: 'Erro na exportação!',
                    text: 'Ocorreu um erro ao gerar o PDF: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Exporta o glossário das fichas selecionadas para PDF
        async function handleExportarGlossarioParaPDF() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxesSelecionados.length === 0) {
                await Swal.fire({
                    title: 'Nenhuma ficha selecionada',
                    text: 'Selecione pelo menos uma ficha para exportar o glossário.',
                    icon: 'warning',
                    confirmButtonColor: '#007bff'
                });
                return;
            }

            try {
                Swal.fire({
                    title: 'Exportando Glossário...',
                    text: 'Preparando o PDF com os valores das fichas selecionadas',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const fichasIds = Array.from(checkboxesSelecionados).map(checkbox =>
                    checkbox.getAttribute('data-id')
                );

                await exportarGlossarioParaPDF(fichasIds);

                Swal.close();
                await Swal.fire({
                    title: 'Glossário exportado!',
                    text: `PDF gerado com ${fichasIds.length} ficha(s) selecionada(s).`,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
            } catch (error) {
                console.error('Erro ao exportar glossário:', error);
                Swal.close();
                await Swal.fire({
                    title: 'Erro na exportação!',
                    text: 'Ocorreu um erro ao gerar o PDF do glossário: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Confirma e exclui a ficha
        async function confirmarExclusaoFicha(codigo) {
            const result = await Swal.fire({
                title: 'Tem certeza?',
                text: "Esta ação irá excluir a ficha e todos os seus itens! Esta ação não pode ser revertida.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir tudo!',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: 'Excluindo...',
                        text: 'Removendo ficha e seus itens',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    await excluirFichaCompleta(codigo);

                    Swal.close();
                    await Swal.fire({
                        title: 'Excluído!',
                        text: 'A ficha e todos os seus itens foram excluídos com sucesso.',
                        icon: 'success',
                        confirmButtonColor: '#28a745'
                    });

                    await carregarFichas();
                } catch (error) {
                    console.error('Erro ao excluir ficha:', error);
                    Swal.close();
                    await Swal.fire({
                        title: 'Erro!',
                        text: 'Erro ao excluir ficha: ' + error.message,
                        icon: 'error',
                        confirmButtonColor: '#d33'
                    });
                }
            }
        }

        // Funções para controlar estados da UI
        function mostrarLoading() {
            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
            tabelaBody.style.display = 'none';
        }

        function mostrarEmptyState() {
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            errorState.style.display = 'none';
            tabelaBody.style.display = 'none';
        }

        function mostrarErro(mensagem) {
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'block';
            errorMessage.textContent = mensagem;
            tabelaBody.style.display = 'none';
        }

        function esconderEstados() {
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
            tabelaBody.style.display = 'table-row-group';
        }

        // Seleciona todos os checkboxes
        selectAll.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            atualizarTodosBotoesExportar();
        });

        // Adiciona os event listener aos botões
        btnExportar.addEventListener('click', handleExportarFichasParaPDF);
        btnExportarGlossario.addEventListener('click', handleExportarGlossarioParaPDF);

        // Torna as funções globais para os event listeners
        window.confirmarExclusaoFicha = confirmarExclusaoFicha;
        window.atualizarBotaoExportar = atualizarBotaoExportar;
        window.atualizarBotaoExportarGlossario = atualizarBotaoExportarGlossario;
        window.atualizarTodosBotoesExportar = atualizarTodosBotoesExportar;

        // Inicializa a aplicação
        document.addEventListener('DOMContentLoaded', inicializarTabela);
    </script>
</body>
</html>