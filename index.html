<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Fichas</title>

    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        h1 {
            color: #333;
            font-size: 24px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-novo, .btn-exportar {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .btn-exportar {
            background-color: #28a745;
        }

        .btn-novo:hover {
            background-color: #0056b3;
        }

        .btn-exportar:hover {
            background-color: #218838;
        }

        .btn-exportar:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .btn-exportar-glossario {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .btn-exportar-glossario:hover {
            background-color: #59359a;
        }

        .btn-exportar-glossario:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .acoes-cell {
            width: 150px;
        }

        .btn-acao {
            padding: 5px 10px;
            margin: 0 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-editar {
            background-color: #28a745;
            color: white;
        }

        .btn-excluir {
            background-color: #dc3545;
            color: white;
        }

        .btn-editar:hover {
            background-color: #218838;
        }

        .btn-excluir:hover {
            background-color: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #007bff;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }

        /* Estilo para botão de exclusão múltipla */
        .btn-excluir-multiplas {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .btn-excluir-multiplas:hover {
            background-color: #c82333;
        }

        .btn-excluir-multiplas:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* Overlay de Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-content {
            color: white;
            padding: 30px 40px;
            text-align: center;
            min-width: 300px;
            border-radius: 10px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 16px;
            margin: 10px 0;
        }

        /* Barra de Progresso */
        .progress-container {
            width: 100%;
            max-width: 300px;
            margin: 20px auto 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: white;
            font-size: 14px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciador de Fichas</h1>
            <div class="btn-group">
                <button id="btnExportar" class="btn-exportar" disabled>Exportar Ficha</button>
                <button id="btnExportarGlossario" class="btn-exportar-glossario" disabled>Exportar Glossário</button>
                <button id="btnExcluirMultiplas" class="btn-excluir-multiplas" disabled>Excluir Selecionadas</button>
                <a href="novo.html" class="btn-novo">Nova Ficha</a>
            </div>
        </div>

        <!-- Overlay de Loading para exclusões -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p class="loading-text" id="loadingText">Excluindo ficha...</p>
                
                <!-- Barra de Progresso -->
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div class="progress-header">
                        <span id="progressText">0%</span>
                        <span id="progressCount">0/0</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="tabelaFichas">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th>ID</th>
                        <th>Nome da Ficha</th>
                        <th>Data de Criação</th>
                        <th class="acoes-cell">Ações</th>
                    </tr>
                </thead>
                <tbody id="tbodyFichas">
                    <!-- As fichas serão inseridas aqui via JavaScript -->
                </tbody>
            </table>
            <div id="loadingState" class="loading">
                <p>Carregando fichas...</p>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <p>Nenhuma ficha cadastrada. Clique em "Nova Ficha" para começar.</p>
            </div>
            <div id="errorState" class="error" style="display: none;">
                <p id="errorMessage">Erro ao carregar fichas.</p>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        // Import das funções da API
        import {
            obterTodasFichas,
            excluirFichaCompletaOtimizada,
            exportarFichasParaPDF,
            exportarGlossarioParaPDF
        } from './api/api.js';

        // Elementos DOM
        const tabelaBody = document.getElementById('tbodyFichas');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const selectAll = document.getElementById('selectAll');
        const btnExportar = document.getElementById('btnExportar');
        const btnExportarGlossario = document.getElementById('btnExportarGlossario');
        const btnExcluirMultiplas = document.getElementById('btnExcluirMultiplas');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressCount = document.getElementById('progressCount');

        // Inicializa a tabela
        async function inicializarTabela() {
            await carregarFichas();
            atualizarTodosBotoes();
        }

        // Carrega as fichas da API
        async function carregarFichas() {
            try {
                mostrarLoading();
                const response = await obterTodasFichas();
                const fichas = extrairFichasDaResposta(response);
                renderizarTabela(fichas);
            } catch (error) {
                console.error('Erro ao carregar fichas:', error);
                mostrarErro('Erro ao carregar fichas: ' + error.message);
            }
        }

        // Função para extrair o array de fichas da resposta da API
        function extrairFichasDaResposta(response) {
            if (Array.isArray(response)) return response;
            if (typeof response === 'object' && response !== null) {
                if (response.data && Array.isArray(response.data)) return response.data;
                if (response.fichas && Array.isArray(response.fichas)) return response.fichas;
                if (response.result && Array.isArray(response.result)) return response.result;
                if (response.items && Array.isArray(response.items)) return response.items;
                const arrayFromObject = Object.values(response).filter(item =>
                    typeof item === 'object' && item !== null
                );
                if (arrayFromObject.length > 0) return arrayFromObject;
            }
            console.warn('Não foi possível extrair array de fichas da resposta:', response);
            return [];
        }

        // Renderiza a tabela com as fichas
        function renderizarTabela(fichas) {
            if (!fichas || !Array.isArray(fichas) || fichas.length === 0) {
                mostrarEmptyState();
                return;
            }

            // ORDENAR AS FICHAS POR ID (do menor para o maior)
            fichas.sort((a, b) => {
                const idA = a.id || a.codigo || a.ID || a.CODIGO || 0;
                const idB = b.id || b.codigo || b.ID || b.CODIGO || 0;
                return idA - idB;
            });

            esconderEstados();
            tabelaBody.innerHTML = '';

            fichas.forEach((ficha) => {
                const tr = document.createElement('tr');
                const dataCriacao = ficha.data_criacao
                    ? new Date(ficha.data_criacao).toLocaleDateString('pt-BR')
                    : 'N/A';
                const fichaId = ficha.id || ficha.codigo || ficha.ID || ficha.CODIGO;

                tr.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" data-id="${fichaId}" data-nome="${ficha.nome_ficha || ficha.nome || 'Sem nome'}" onchange="atualizarTodosBotoes()">
                    </td>
                    <td>${fichaId || 'N/A'}</td>
                    <td>${ficha.nome_ficha || ficha.nome || 'Sem nome'}</td>
                    <td>${dataCriacao}</td>
                    <td class="acoes-cell">
                        <a href="editar.html?id=${fichaId}" class="btn-acao btn-editar">Editar</a>
                        <button class="btn-acao btn-excluir" onclick="confirmarExclusaoFicha('${fichaId}', '${ficha.nome_ficha || ficha.nome || 'Ficha'}')">Excluir</button>
                    </td>
                `;
                tabelaBody.appendChild(tr);
            });
        }

        // Função para mostrar progresso
        function mostrarProgresso(atual, total) {
            if (progressContainer && progressBar && progressText && progressCount) {
                progressContainer.style.display = 'block';
                const porcentagem = Math.round((atual / total) * 100);
                progressBar.style.width = `${porcentagem}%`;
                progressText.textContent = `${porcentagem}%`;
                progressCount.textContent = `${atual}/${total}`;
            }
        }

        // Função para esconder progresso
        function esconderProgresso() {
            if (progressContainer) {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                progressCount.textContent = '0/0';
            }
        }

        // Atualiza o estado do botão exportar
        function atualizarBotaoExportar() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            btnExportar.disabled = checkboxesSelecionados.length === 0;
        }

        // Atualiza o estado do botão exportar glossário
        function atualizarBotaoExportarGlossario() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            btnExportarGlossario.disabled = checkboxesSelecionados.length === 0;
        }

        // Atualiza o estado do botão excluir múltiplas
        function atualizarBotaoExcluirMultiplas() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            btnExcluirMultiplas.disabled = checkboxesSelecionados.length === 0;
        }

        // Atualiza todos os botões
        function atualizarTodosBotoes() {
            atualizarBotaoExportar();
            atualizarBotaoExportarGlossario();
            atualizarBotaoExcluirMultiplas();
        }

        // Exporta as fichas selecionadas para PDF
        async function handleExportarFichasParaPDF() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxesSelecionados.length === 0) {
                await Swal.fire({
                    title: 'Nenhuma ficha selecionada',
                    text: 'Selecione pelo menos uma ficha para exportar.',
                    icon: 'warning',
                    confirmButtonColor: '#007bff'
                });
                return;
            }

            try {
                Swal.fire({
                    title: 'Exportando...',
                    text: 'Preparando o PDF com as fichas selecionadas',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const fichasIds = Array.from(checkboxesSelecionados).map(checkbox =>
                    checkbox.getAttribute('data-id')
                );

                await exportarFichasParaPDF(fichasIds);

                Swal.close();
                await Swal.fire({
                    title: 'Exportação concluída!',
                    text: `PDF gerado com ${fichasIds.length} ficha(s) selecionada(s).`,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
            } catch (error) {
                console.error('Erro ao exportar fichas:', error);
                Swal.close();
                await Swal.fire({
                    title: 'Erro na exportação!',
                    text: 'Ocorreu um erro ao gerar o PDF: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Exporta o glossário das fichas selecionadas para PDF
        async function handleExportarGlossarioParaPDF() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxesSelecionados.length === 0) {
                await Swal.fire({
                    title: 'Nenhuma ficha selecionada',
                    text: 'Selecione pelo menos uma ficha para exportar o glossário.',
                    icon: 'warning',
                    confirmButtonColor: '#007bff'
                });
                return;
            }

            try {
                Swal.fire({
                    title: 'Exportando Glossário...',
                    text: 'Preparando o PDF com os valores das fichas selecionadas',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const fichasIds = Array.from(checkboxesSelecionados).map(checkbox =>
                    checkbox.getAttribute('data-id')
                );

                await exportarGlossarioParaPDF(fichasIds);

                Swal.close();
                await Swal.fire({
                    title: 'Glossário exportado!',
                    text: `PDF gerado com ${fichasIds.length} ficha(s) selecionada(s).`,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
            } catch (error) {
                console.error('Erro ao exportar glossário:', error);
                Swal.close();
                await Swal.fire({
                    title: 'Erro na exportação!',
                    text: 'Ocorreu um erro ao gerar o PDF do glossário: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Confirma e exclui a ficha (única)
        async function confirmarExclusaoFicha(codigo, nomeFicha) {
            const result = await Swal.fire({
                title: 'Tem certeza?',
                html: `Esta ação irá excluir a ficha <strong>"${nomeFicha}"</strong> e todos os seus itens!<br><br>Esta ação não pode ser revertida.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sim, excluir tudo!',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            });

            if (result.isConfirmed) {
                await excluirFichaComCodigo(codigo, nomeFicha);
            }
        }

        // Confirma e exclui múltiplas fichas
        async function confirmarExclusaoMultiplasFichas() {
            const checkboxesSelecionados = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxesSelecionados.length === 0) {
                await Swal.fire({
                    title: 'Nenhuma ficha selecionada',
                    text: 'Selecione pelo menos uma ficha para excluir.',
                    icon: 'warning',
                    confirmButtonColor: '#007bff'
                });
                return;
            }

            const fichasSelecionadas = Array.from(checkboxesSelecionados).map(checkbox => ({
                id: checkbox.getAttribute('data-id'),
                nome: checkbox.getAttribute('data-nome')
            }));

            const listaNomes = fichasSelecionadas.map(f => `• ${f.nome}`).join('<br>');
            
            const result = await Swal.fire({
                title: 'Tem certeza?',
                html: `Esta ação irá excluir <strong>${fichasSelecionadas.length} ficha(s)</strong> e todos os seus itens!<br><br>
                      <strong>Fichas selecionadas:</strong><br>
                      ${listaNomes}<br><br>
                      Esta ação não pode ser revertida.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: `Sim, excluir ${fichasSelecionadas.length} ficha(s)!`,
                cancelButtonText: 'Cancelar',
                reverseButtons: true,
                width: '600px'
            });

            if (result.isConfirmed) {
                await excluirMultiplasFichas(fichasSelecionadas);
            }
        }

        // Exclui uma ficha específica
        async function excluirFichaComCodigo(codigo, nomeFicha) {
            try {
                // Mostra overlay de loading
                loadingText.textContent = `Excluindo ficha: ${nomeFicha}`;
                loadingOverlay.style.display = 'flex';
                esconderProgresso();

                await excluirFichaCompletaOtimizada(codigo);

                loadingOverlay.style.display = 'none';

                await Swal.fire({
                    title: 'Excluído!',
                    text: `A ficha "${nomeFicha}" e todos os seus itens foram excluídos com sucesso.`,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });

                await carregarFichas();
            } catch (error) {
                console.error('Erro ao excluir ficha:', error);
                loadingOverlay.style.display = 'none';
                await Swal.fire({
                    title: 'Erro!',
                    text: `Erro ao excluir ficha "${nomeFicha}": ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Exclui múltiplas fichas em paralelo
        async function excluirMultiplasFichas(fichas) {
            try {
                // Mostra overlay de loading com progresso
                loadingText.textContent = `Excluindo ${fichas.length} ficha(s)...`;
                loadingOverlay.style.display = 'flex';
                mostrarProgresso(0, fichas.length);

                let sucessos = 0;
                let falhas = 0;
                const resultados = [];

                // Cria promises para excluir todas as fichas em paralelo
                const promises = fichas.map((ficha, index) => 
                    excluirFichaCompletaOtimizada(ficha.id)
                        .then(() => {
                            sucessos++;
                            mostrarProgresso(sucessos + falhas, fichas.length);
                            resultados.push({ success: true, ficha });
                            return { success: true, ficha };
                        })
                        .catch(error => {
                            falhas++;
                            mostrarProgresso(sucessos + falhas, fichas.length);
                            resultados.push({ success: false, ficha, error });
                            return { success: false, ficha, error };
                        })
                );

                // Executa todas as exclusões em paralelo
                await Promise.all(promises);

                loadingOverlay.style.display = 'none';
                esconderProgresso();

                // Mostra resultado
                if (falhas === 0) {
                    await Swal.fire({
                        title: 'Sucesso!',
                        html: `<strong>${sucessos} ficha(s)</strong> excluída(s) com sucesso.`,
                        icon: 'success',
                        confirmButtonColor: '#28a745'
                    });
                } else if (sucessos > 0) {
                    const fichasFalhas = resultados.filter(r => !r.success).map(r => r.ficha.nome);
                    await Swal.fire({
                        title: 'Resultado parcial',
                        html: `<strong>${sucessos} ficha(s)</strong> excluída(s) com sucesso.<br>
                              <strong>${falhas} ficha(s)</strong> falharam:<br>
                              ${fichasFalhas.map(nome => `• ${nome}`).join('<br>')}`,
                        icon: 'warning',
                        confirmButtonColor: '#ffc107'
                    });
                } else {
                    await Swal.fire({
                        title: 'Erro!',
                        text: 'Todas as fichas falharam ao excluir.',
                        icon: 'error',
                        confirmButtonColor: '#d33'
                    });
                }

                // Recarrega a tabela
                await carregarFichas();
            } catch (error) {
                console.error('Erro ao excluir múltiplas fichas:', error);
                loadingOverlay.style.display = 'none';
                esconderProgresso();
                await Swal.fire({
                    title: 'Erro!',
                    text: 'Erro ao excluir fichas: ' + error.message,
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Funções para controlar estados da UI
        function mostrarLoading() {
            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
            tabelaBody.style.display = 'none';
        }

        function mostrarEmptyState() {
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
            errorState.style.display = 'none';
            tabelaBody.style.display = 'none';
        }

        function mostrarErro(mensagem) {
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'block';
            errorMessage.textContent = mensagem;
            tabelaBody.style.display = 'none';
        }

        function esconderEstados() {
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
            tabelaBody.style.display = 'table-row-group';
        }

        // Seleciona todos os checkboxes
        selectAll.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            atualizarTodosBotoes();
        });

        // Adiciona os event listener aos botões
        btnExportar.addEventListener('click', handleExportarFichasParaPDF);
        btnExportarGlossario.addEventListener('click', handleExportarGlossarioParaPDF);
        btnExcluirMultiplas.addEventListener('click', confirmarExclusaoMultiplasFichas);

        // Torna as funções globais para os event listeners
        window.confirmarExclusaoFicha = confirmarExclusaoFicha;
        window.atualizarBotaoExportar = atualizarBotaoExportar;
        window.atualizarBotaoExportarGlossario = atualizarBotaoExportarGlossario;
        window.atualizarBotaoExcluirMultiplas = atualizarBotaoExcluirMultiplas;
        window.atualizarTodosBotoes = atualizarTodosBotoes;

        // Inicializa a aplicação
        document.addEventListener('DOMContentLoaded', inicializarTabela);
    </script>
</body>
</html>